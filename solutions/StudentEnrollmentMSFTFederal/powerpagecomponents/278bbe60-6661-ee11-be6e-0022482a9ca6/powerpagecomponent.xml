<powerpagecomponent powerpagecomponentid="278bbe60-6661-ee11-be6e-0022482a9ca6">
  <content>{
  "copy": "{% include 'Portal Web API Wrapper' %}\r\n&lt;div class=\"row sectionBlockLayout\" style=\"display: flex; flex-wrap: wrap; padding: 8px; margin: 0px; text-align: left; min-height: 40px;\"&gt;\r\n  &lt;div class=\"container\" style=\"display: flex; flex-wrap: wrap;\"&gt;\r\n    &lt;div class=\"col-md-12 columnBlockLayout back-container\" style=\"flex-grow: 1; min-width: 300px; display: flex; flex-direction: column;\"&gt;\r\n      &lt;a href=\"/\"&gt;&lt;img src=\"/back-arrow.svg\" alt=\"back arrow\" class=\"back-arrow\" style=\"max-width: 100%;\"&gt;\r\n        &lt;span&gt;Back to events catalog&lt;/span&gt;\r\n      &lt;/a&gt;\r\n      {% include 'View Course Details' %}\r\n    &lt;/div&gt;\r\n  &lt;/div&gt;\r\n&lt;/div&gt;\r\n\r\n&lt;!-- START MODAL --&gt;\r\n  &lt;div class=\"modal fade\" id=\"addAttendeeModal1\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"addAttendeeModal1\" aria-hidden=\"true\"&gt;\r\n      &lt;div class=\"modal-dialog modal-dialog-centered\" role=\"document\"&gt;\r\n          &lt;div class=\"modal-content\"&gt;\r\n              &lt;div class=\"modal-header\"&gt;\r\n                  &lt;h2 class=\"modal-title\"&gt;Add attendee information&lt;/h2&gt;\r\n              &lt;/div&gt;\r\n              &lt;div class=\"modal-body\"&gt;\r\n                  &lt;iframe width=\"100%\" height=\"650\" id=\"add-child-wrapper\" src=\"/add-attendee\" frameborder=\"0\" allowfullscreen=\"\"&gt;&lt;/iframe&gt;\r\n              &lt;/div&gt;\r\n          &lt;/div&gt;\r\n      &lt;/div&gt;\r\n  &lt;/div&gt;\r\n  &lt;!-- END MODAL --&gt;",
  "customcss": "img.disabled {\r\n    opacity: 0.4;\r\n    cursor: default;\r\n}\r\n\r\np.disabled {\r\n    opacity: 0.5;\r\n    cursor: default;\r\n}\r\n\r\nimg.disabled+p {\r\n    cursor: default;\r\n}\r\n#description\r\n{word-wrap: break-word;}",
  "customjavascript": "let selectedAttendees = [];\r\nlet registrationCounter = 0;\r\n\r\n// allows close modal from the popup  \r\nwindow.closeModal = function () {\r\n    $('#addAttendeeModal1').modal('hide');\r\n};\r\n\r\n$(document).ready(function(){\r\n\r\n    let courseId = \"{{request.params['id'] | xml_escape}}\";\r\n\r\n    //Get the image\r\n    webapi.safeAjax({\r\n        type: \"GET\",\r\n        url: \"/_api/msdynce_courses({{request.params['id']}})/msdynce_entityimage/?size=full\",\r\n        contentType: \"application/json\",\r\n        success: function (res, status) {\r\n            if (res){\r\n                imgBaseString = res.value;\r\n                $(\".image-view\").attr(\"src\", \"data:image/png;base64,\" + imgBaseString);\r\n            }\r\n        }\r\n    });\r\n\r\n    $(\".card-body span.date\").each(function(){\r\n        var date = moment.utc(this.innerHTML);\r\n        $(this).text(moment(date).local().format(\"MMMM DD\"));\r\n    });\r\n\r\n    $(\".card-body span.time\").each(function(){\r\n        var time = moment.utc(this.innerHTML);\r\n        $(this).text(moment(time).local().format(\"hh:mm a\"));\r\n    });\r\n\r\n    {% if user and user.roles contains 'C1 ASP' %}\r\n    $(\".back-container a\").attr(\"href\", \"{{ sitemarkers['C1 Home'].url }}\");\r\n    $(\".back-container a&gt;span\").text(\"{{snippets['Text/Back to my courses']}}\");\r\n    {% endif %}\r\n\r\n    $(\".child-selection-container input[type='checkbox']\").on(\"change\", function(){\r\n        if (this.checked)\r\n            selectedAttendees.push(this.value);\r\n        else {\r\n            var pos = selectedAttendees.indexOf(this.value);\r\n            selectedAttendees.splice(pos, 1);\r\n        }\r\n    });\r\n\r\n    {% if user %}\r\n    {% unless user.roles contains 'C1 ASP' %}\r\n    $(\".child-selection-container img:not(.child-selection-container img:last-child)\").each(function(){\r\n        var imgURL = \"\";\r\n        var objectId = this.dataset.contact;\r\n        var currentElement = this;\r\n        webapi.safeAjax({\r\n        type: \"GET\",\r\n        url: \"/_api/contacts(\" + objectId + \")?$select=entityimage\",\r\n        contentType: \"application/json\",\r\n        success: function (res, status) {\r\n            if (res.entityimage){\r\n                var imgBaseString = res.entityimage;\r\n                var imgHTML = \"\";\r\n                imgURL = \"data:image/png;base64,\" + imgBaseString;\r\n                $(currentElement).attr(\"src\", imgURL);\r\n            }   \r\n        }\r\n        });\r\n    });\r\n    {% endunless %}\r\n    {% endif %}\r\n\r\n    $(\"#registerBtn\").on(\"click\", function(e){\r\n        e.preventDefault();\r\n        {% if user %}\r\n        {% unless user.roles contains 'C1 ASP' %}\r\n        //Remove any alerts\r\n        $(\".alert-danger\").remove();\r\n        registrationCounter = 0;\r\n        if (selectedAttendees.length &gt; 0){\r\n            //Validate that there are still spots available\r\n            webapi.safeAjax({\r\n            type: \"GET\",\r\n            url: \"/_api/msdynce_courses(\" + courseId + \")?$select=msdynce_registeredparticipants,msdynce_filledpercent,\" +\r\n            \"msdynce_registerationmaxcapacity,msdynce_registerationdeadline,msdynce_coursestartdateandtime,msdynce_courseenddateandtime,\" +\r\n            \"msdynce_coursename\",\r\n            contentType: \"application/json\",\r\n            success: function (res) {\r\n                var deadline = res.msdynce_registerationdeadline;\r\n                var maxCapacity = res.msdynce_registerationmaxcapacity;\r\n                var startDate = res.msdynce_coursestartdateandtime;\r\n                var endDate = res.msdynce_courseenddateandtime;\r\n                var courseTitle = res.msdynce_coursename;\r\n                if (res.msdynce_registeredparticipants)\r\n                   var  regParticipants = res.msdynce_registeredparticipants;\r\n                else \r\n                    var regParticipants = 0;\r\n                if (regParticipants &lt; maxCapacity) {\r\n                spots = maxCapacity - regParticipants;\r\n                if (selectedAttendees.length &lt;= spots){\r\n                    var now = moment().local().format(\"YYYY-MM-DD\");\r\n                    var limit = moment(deadline).local().format(\"YYYY-MM-DD\");\r\n                    if (moment(now).isBefore(limit) || moment(now).isSame(limit)){\r\n                    document.getElementById(\"registerBtn\").disabled = true;\r\n                    document.getElementById(\"registerBtn\").innerText = \"Processing...\";\r\n                    selectedAttendees.forEach(function(element, index, array){\r\n                        createRegistrationRecord(element, courseId , array.length, regParticipants, maxCapacity, startDate, endDate, courseTitle);\r\n                    });\r\n                    } else {\r\n                    showErrorMessage(\"The registration deadline for this course has expired.\");\r\n                    }\r\n                } else{\r\n                    showErrorMessage(\"There aren't enough spots left for the amount of people selected.\");\r\n                }\r\n                }\r\n                else{\r\n                showErrorMessage(\"This course is full\");\r\n                }\r\n            },\r\n            error: function (res) {\r\n                console.log(res.responseText);\r\n                showErrorMessage(\"We’re sorry. Your request didn’t go through. Please try again.\");\r\n            }\r\n            });\r\n        } else {\r\n            showErrorMessage(\"Please fill out all required fields to complete your registration.\");\r\n        }\r\n        {% endunless %}\r\n        {% endif %}\r\n    });\r\n\r\n});\r\n\r\n    function createRegistrationRecord(attendee, courseId, length, participants, capacity, startDate, endDate, courseTitle){\r\n\r\n      var dataObject = {\r\n        \"msdynce_courseid@odata.bind\": \"/msdynce_courses(\" + courseId + \")\",\r\n        \"msdynce_AttendeeName@odata.bind\": \"/contacts(\" + attendee + \")\",\r\n        \"msdynce_coursestartdate\": startDate,\r\n        \"msdynce_courseenddate\": endDate,\r\n        \"msdynce_name\": courseTitle,\r\n        \"msdynce_Parent@odata.bind\": \"/contacts({{user.contactid}})\"\r\n      }\r\n\r\n      //Call the API\r\n        webapi.safeAjax({\r\n          type: \"POST\",\r\n          url: \"/_api/msdynce_registrations\",\r\n          contentType: \"application/json\",\r\n          data: JSON.stringify(dataObject),\r\n          success: function (res, status, xhr) {\r\n            //print id of newly created table record\r\n            registrationCounter++;\r\n            if (registrationCounter == length){\r\n              var newParticipants = participants + length;\r\n              var newFilled = (newParticipants * 100) / capacity;\r\n              updateCourseParticipants(courseId,newParticipants,newFilled);\r\n            }\r\n          },\r\n          error: function (res, status, xhr) {\r\n            console.log(res.responseText);\r\n            showErrorMessage(\"We’re sorry. Your request didn’t go through. Please try again.\");\r\n          }\r\n        });\r\n    }\r\n\r\n    function updateCourseParticipants(courseId, participants, filled){\r\n      webapi.safeAjax({\r\n        type: \"PATCH\",\r\n        url: \"/_api/msdynce_courses(\" + courseId + \")\",\r\n        contentType: \"application/json\",\r\n        data: JSON.stringify({\r\n          \"msdynce_registeredparticipants\": participants\r\n        }),\r\n        success: function (res) {\r\n          window.location.href = \"{{sitemarkers['Registration Success'].url}}?id=\" + courseId;\r\n        },\r\n        error: function (res) {\r\n          console.log(res.responseText);\r\n          showErrorMessage(\"We’re sorry. Your request didn’t go through. Please try again.\");\r\n        }\r\n      });\r\n    }\r\n\r\n    function showErrorMessage(message){\r\n        $(\".child-selection-container\").before(\"&lt;div class='alert alert-danger validation-alert' role='alert'&gt;\" +\r\n      \"&lt;img src='/validation-icon.svg' style='margin-bottom:5px;' alt='validation alert icon'&gt;\" +\r\n      \"&lt;b&gt;\" + message + \"&lt;/b&gt;\" +\r\n      \"&lt;br&gt;&lt;/div&gt;\");\r\n    }\r\n",
  "displayorder": 11,
  "enablerating": false,
  "enabletracking": false,
  "excludefromsearch": false,
  "feedbackpolicy": 756150000,
  "hiddenfromsitemap": false,
  "isroot": false,
  "pagetemplateid": "63cd665a-6661-ee11-be6e-0022482a9ca6",
  "parentpageid": "c9ec5562-6661-ee11-be6e-0022482a9f76",
  "partialurl": "course-details",
  "publishingstateid": "9562e260-6661-ee11-be6e-0022482a998f",
  "rootwebpageid": "fea6ba5e-6661-ee11-be6e-0022482803f8",
  "sharedpageconfiguration": true,
  "summary": "&lt;p&gt;This is sample landing page for you to start building your website&lt;/p&gt;",
  "title": "View Course Details"
}</content>
  <iscustomizable>1</iscustomizable>
  <name>View Course Details</name>
  <powerpagecomponenttype>2</powerpagecomponenttype>
  <powerpagesiteid>
    <powerpagesiteid>d8ec5562-6661-ee11-be6e-0022482a9f76</powerpagesiteid>
  </powerpagesiteid>
  <powerpagesitelanguageid>
    <powerpagesitelanguageid>b8f67061-6661-ee11-be6e-0022482a91f4</powerpagesitelanguageid>
  </powerpagesitelanguageid>
  <searchcontent>View Course Details{% include 'Portal Web API Wrapper' %}
&lt;div class="row sectionBlockLayout" style="display: flex; flex-wrap: wrap; padding: 8px; margin: 0px; text-align: left; min-height: 40px;"&gt;
  &lt;div class="container" style="display: flex; flex-wrap: wrap;"&gt;
    &lt;div class="col-md-12 columnBlockLayout back-container" style="flex-grow: 1; min-width: 300px; display: flex; flex-direction: column;"&gt;
      &lt;a href="/"&gt;&lt;img src="/back-arrow.svg" alt="back arrow" class="back-arrow" style="max-width: 100%;"&gt;
        &lt;span&gt;Back to events catalog&lt;/span&gt;
      &lt;/a&gt;
      {% include 'View Course Details' %}
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;!-- START MODAL --&gt;
  &lt;div class="modal fade" id="addAttendeeModal1" tabindex="-1" role="dialog" aria-labelledby="addAttendeeModal1" aria-hidden="true"&gt;
      &lt;div class="modal-dialog modal-dialog-centered" role="document"&gt;
          &lt;div class="modal-content"&gt;
              &lt;div class="modal-header"&gt;
                  &lt;h2 class="modal-title"&gt;Add attendee information&lt;/h2&gt;
              &lt;/div&gt;
              &lt;div class="modal-body"&gt;
                  &lt;iframe width="100%" height="650" id="add-child-wrapper" src="/add-attendee" frameborder="0" allowfullscreen=""&gt;&lt;/iframe&gt;
              &lt;/div&gt;
          &lt;/div&gt;
      &lt;/div&gt;
  &lt;/div&gt;
  &lt;!-- END MODAL --&gt;View Course Details</searchcontent>
  <statecode>0</statecode>
  <statuscode>1</statuscode>
</powerpagecomponent>